<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>ProIgualdad – Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    @media print { .no-print{display:none!important} .print-break{page-break-before:always} }
    .table-wrap{overflow:auto}
    .badge{padding:.125rem .5rem;border-radius:9999px;font-size:.75rem;font-weight:600;display:inline-block}
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
<header class="bg-white shadow">
  <div class="mx-auto max-w-7xl px-4 py-5">
    <h1 class="text-2xl font-bold">Sistema de Monitoreo – ProIgualdad</h1>
    <p class="text-sm text-gray-600">Dashboard conectado a Supabase</p>
  </div>
</header>

<main class="mx-auto max-w-7xl px-4 py-6">

  <!-- Panel superior -->
  <section class="mb-4 no-print">
    <div class="grid md:grid-cols-3 gap-3">
      <div class="bg-white rounded-xl p-4 shadow">
        <h2 class="font-semibold mb-2">Conexión</h2>
        <div class="text-xs text-gray-600">Credenciales ya configuradas.</div>
        <div id="connStatus" class="mt-2 text-sm"></div>
      </div>
      <div class="bg-white rounded-xl p-4 shadow">
        <h2 class="font-semibold mb-2">Controles</h2>
        <div class="flex gap-2 flex-wrap">
          <button id="btnReload" class="px-3 py-2 rounded-lg bg-black text-white hover:bg-gray-800">Recargar</button>
          <button id="btnExport" class="px-3 py-2 rounded-lg bg-gray-700 text-white hover:bg-gray-600">Exportar CSV</button>
          <button id="btnPrint" class="px-3 py-2 rounded-lg bg-orange-600 text-white hover:bg-orange-500">Imprimir / PDF</button>
        </div>
      </div>
      <div class="bg-white rounded-xl p-4 shadow">
        <h2 class="font-semibold mb-2">Filtros</h2>
        <div class="grid grid-cols-2 gap-2">
          <select id="fAnio" class="border rounded-lg px-2 py-1"><option value="">Año</option></select>
          <select id="fComponente" class="border rounded-lg px-2 py-1"><option value="">Componente</option></select>
          <select id="fEstado" class="border rounded-lg px-2 py-1"><option value="">Estado</option></select>
          <select id="fMes" class="border rounded-lg px-2 py-1"><option value="">Mes</option></select>
          <select id="fResp" class="border rounded-lg px-2 py-1 col-span-2"><option value="">Responsable</option></select>
        </div>
        <div class="mt-2">
          <button id="btnReset" class="text-sm underline text-gray-600">Limpiar filtros</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Tabs -->
  <section class="mb-4">
    <div class="no-print bg-white rounded-xl p-2 shadow flex gap-2 flex-wrap">
      <button data-tab="indicadores" class="tabbtn px-3 py-2 rounded-lg bg-black text-white">Indicadores</button>
      <button data-tab="actividades" class="tabbtn px-3 py-2 rounded-lg hover:bg-gray-200">Actividades</button>
      <button data-tab="cronograma"  class="tabbtn px-3 py-2 rounded-lg hover:bg-gray-200">Cronograma</button>
      <button data-tab="componentes" class="tabbtn px-3 py-2 rounded-lg hover:bg-gray-200">Componentes</button>
    </div>
  </section>

  <!-- Indicadores -->
  <section id="tab-indicadores" class="tab">
    <div class="grid lg:grid-cols-2 gap-4">
      <div class="bg-white rounded-xl p-4 shadow">
        <h3 class="font-semibold mb-2">% Avance por Indicador</h3>
        <canvas id="chartIndicadores" height="220"></canvas>
      </div>
      <div class="bg-white rounded-xl p-4 shadow">
        <h3 class="font-semibold mb-3">Tabla de Indicadores</h3>
        <div class="table-wrap">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-left border-b">
                <th class="py-2 pr-3">Año</th>
                <th class="py-2 pr-3">Indicador</th>
                <th class="py-2 pr-3">Meta</th>
                <th class="py-2 pr-3">Avance</th>
                <th class="py-2 pr-3">% Cumpl.</th>
                <th class="py-2 pr-3">Estado</th>
              </tr>
            </thead>
            <tbody id="tblIndicadores"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- Actividades -->
  <section id="tab-actividades" class="tab hidden print-break">
    <div class="bg-white rounded-xl p-4 shadow">
      <h3 class="font-semibold mb-3">Actividades (con KPIs y enlaces de evidencia)</h3>
      <div class="table-wrap">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left border-b">
              <th class="py-2 pr-3">Año</th>
              <th class="py-2 pr-3">Componente</th>
              <th class="py-2 pr-3">Actividad Principal</th>
              <th class="py-2 pr-3">Subactividad</th>
              <th class="py-2 pr-3">Tarea específica</th>
              <th class="py-2 pr-3">Mes</th>
              <th class="py-2 pr-3">Resp.</th>
              <th class="py-2 pr-3">Estado</th>
              <th class="py-2 pr-3">Evidencia</th>
            </tr>
          </thead>
          <tbody id="tblActividades"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Cronograma -->
  <section id="tab-cronograma" class="tab hidden print-break">
    <div class="bg-white rounded-xl p-4 shadow">
      <h3 class="font-semibold mb-3">Cronograma (Mini-Gantt Mes × Actividad Principal)</h3>
      <div class="table-wrap">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left border-b">
              <th class="py-2 pr-3">Actividad Principal</th>
              <th class="py-2 pr-3">Año</th>
              <th class="py-2 pr-3">Componente</th>
              <th class="py-2 px-2">E</th><th class="py-2 px-2">F</th><th class="py-2 px-2">M</th><th class="py-2 px-2">A</th>
              <th class="py-2 px-2">M</th><th class="py-2 px-2">J</th><th class="py-2 px-2">J</th><th class="py-2 px-2">A</th>
              <th class="py-2 px-2">S</th><th class="py-2 px-2">O</th><th class="py-2 px-2">N</th><th class="py-2 px-2">D</th>
            </tr>
          </thead>
          <tbody id="tblCronograma"></tbody>
        </table>
      </div>
      <p class="text-xs text-gray-500 mt-2">Cada celda marcada indica que hubo al menos una tarea en ese mes para esa Actividad Principal.</p>
    </div>
  </section>

  <!-- Componentes -->
  <section id="tab-componentes" class="tab hidden print-break">
    <div class="grid lg:grid-cols-2 gap-4">
      <div class="bg-white rounded-xl p-4 shadow">
        <h3 class="font-semibold mb-2">Promedio de % Cumplimiento por Componente</h3>
        <canvas id="chartComponentes" height="220"></canvas>
      </div>
      <div class="bg-white rounded-xl p-4 shadow">
        <h3 class="font-semibold mb-3">Tabla agregada por Componente</h3>
        <div class="table-wrap">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-left border-b">
                <th class="py-2 pr-3">Componente</th>
                <th class="py-2 pr-3">Indicadores</th>
                <th class="py-2 pr-3">Prom. %</th>
                <th class="py-2 pr-3">Avances</th>
              </tr>
            </thead>
            <tbody id="tblComponentes"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

</main>

<footer class="mx-auto max-w-7xl px-4 py-6 text-xs text-gray-500">
  ProIgualdad · GIZ Bolivia · Dashboard en Cloudflare Pages + Supabase
</footer>

<script>
/* ====== SUPABASE CONFIG (tus credenciales) ====== */
const SUPABASE_URL = "https://xrvxryozthadpzsgmbir.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhydnhyeW96dGhhZHB6c2dtYmlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5ODA5NjcsImV4cCI6MjA3NDU1Njk2N30.mVDnVaJCiJzSEFJ2ZlHGrtbFk-DZNb61aDcrNf3KsHg";
const TABLE_NAME = "entradas_form";

/* ====== CLIENT ====== */
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ====== UTILIDADES ====== */
const meses = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
const mesToIdx = (m) => { if(!m) return -1; const s=String(m).trim().toLowerCase(); const n=Number(s); if(!isNaN(n)&&n>=1&&n<=12) return n-1; return meses.indexOf(s); };
const fmtPct = (v)=> (v==null||isNaN(v)) ? "" : (Math.round(Number(v)*10)/10)+"%";
const clamp = (n,min,max)=> Math.max(min, Math.min(max, n));

function badgeEstado(estadoRaw){
  const e = String(estadoRaw||"").toLowerCase();
  if (e.includes("complet")) return '<span class="badge bg-green-100 text-green-800">Completado</span>';
  if (e.includes("proceso") || e.includes("progres")) return '<span class="badge bg-yellow-100 text-yellow-800">En proceso</span>';
  if (e.includes("retras")) return '<span class="badge bg-red-100 text-red-800">Retrasado</span>';
  if (e.includes("reprogram")) return '<span class="badge bg-blue-100 text-blue-800">Reprogramado</span>'; // azul
  return `<span class="badge bg-gray-100 text-gray-800">${estadoRaw||"Pendiente"}</span>`;
}

function calcPct(meta, avance, pct){
  if (pct!=null && pct!=="") return Number(pct);
  const m = Number(meta), a = Number(avance);
  if (!isNaN(m) && m>0 && !isNaN(a)) return clamp((a/m)*100, 0, 9999);
  return null;
}

function uniqueSorted(arr){
  return [...new Set(arr.filter(Boolean))].sort((a,b)=> {
    // números
    const na=Number(a), nb=Number(b);
    if(!isNaN(na)&&!isNaN(nb)) return na-nb;
    // meses
    const ia=mesToIdx(a), ib=mesToIdx(b);
    if(ia>=0 && ib>=0) return ia-ib;
    // texto
    return String(a).localeCompare(String(b));
  });
}

/* ====== ESTADO GLOBAL ====== */
let RAW=[], FILT=[], chartIndic=null, chartComp=null;

/* ====== CARGA ====== */
async function testConnection(){
  try{
    const { error } = await supabase.from(TABLE_NAME).select('count').limit(1);
    if (error) throw error;
    document.getElementById('connStatus').innerHTML = '<span class="badge bg-green-100 text-green-800">OK</span> Conectado';
  }catch(err){
    document.getElementById('connStatus').innerHTML = `<span class="badge bg-red-100 text-red-800">Error</span> ${err.message}`;
  }
}

async function fetchAll(){
  const cols=['anio_gestion','componente','indicador','meta','avance','porcentaje_cumplimiento','estado','actividad_principal','subactividad','tarea_especifica','responsable','mes','evidencia_url'];
  const { data, error } = await supabase
    .from(TABLE_NAME)
    .select(cols.join(','))
    .order('anio_gestion', { ascending: true })
    .order('mes', { ascending: true });
  if (error) throw error;
  RAW = data || [];
}

/* ====== FILTROS ====== */
function applyFilters(){
  const anio = document.getElementById('fAnio').value;
  const comp = document.getElementById('fComponente').value;
  const est  = document.getElementById('fEstado').value;
  const mes  = document.getElementById('fMes').value;
  const resp = document.getElementById('fResp').value;

  FILT = RAW.filter(r=>{
    if (anio && String(r.anio_gestion)!==anio) return false;
    if (comp && String(r.componente)!==comp) return false;
    if (est  && String(r.estado)!==est) return false;
    if (mes  && String(r.mes)!==mes) return false;
    if (resp && String(r.responsable)!==resp) return false;
    return true;
  });
}

function populateFilterOptions(){
  const by = (k)=> uniqueSorted(RAW.map(r=>r[k]));
  const set = (id, arr, label)=>{
    const el=document.getElementById(id);
    const sel=el.value;
    el.innerHTML = `<option value="">${label}</option>` + arr.map(v=>`<option>${v}</option>`).join('');
    if(arr.includes(sel)) el.value=sel;
  };
  set('fAnio', by('anio_gestion'), 'Año');
  set('fComponente', by('componente'), 'Componente');
  set('fEstado', by('estado'), 'Estado');
  set('fMes', uniqueSorted(RAW.map(r=>r.mes)), 'Mes');
  set('fResp', by('responsable'), 'Responsable');
}

/* ====== RENDER: INDICADORES ====== */
function renderIndicadores(){
  const tb=document.getElementById('tblIndicadores'); tb.innerHTML='';
  const rows={};
  FILT.forEach(r=>{
    if(!r.indicador) return;
    const key = `${r.anio_gestion}||${r.indicador}`;
    const pct = calcPct(r.meta, r.avance, r.porcentaje_cumplimiento);
    if(!rows[key]) rows[key]={anio:r.anio_gestion, ind:r.indicador, meta:r.meta, av:r.avance, pcts:[], est:r.estado||""};
    if(pct!=null) rows[key].pcts.push(pct);
  });
  const arr=Object.values(rows).sort((a,b)=> (a.anio-b.anio) || String(a.ind).localeCompare(String(b.ind)));
  arr.forEach(x=>{
    const avg = x.pcts.length ? x.pcts.reduce((s,v)=>s+v,0)/x.pcts.length : calcPct(x.meta, x.av, null);
    tb.insertAdjacentHTML('beforeend', `
      <tr class="border-b last:border-0">
        <td class="py-2 pr-3">${x.anio??""}</td>
        <td class="py-2 pr-3">${x.ind??""}</td>
        <td class="py-2 pr-3">${x.meta??""}</td>
        <td class="py-2 pr-3">${x.av??""}</td>
        <td class="py-2 pr-3">${avg==null?"":fmtPct(avg)}</td>
        <td class="py-2 pr-3">${badgeEstado(x.est)}</td>
      </tr>
    `);
  });

  // Chart
  const labels = arr.map(x=> `${x.anio??""} · ${x.ind??""}`);
  const values = arr.map(x=>{
    const avg = x.pcts.length ? x.pcts.reduce((s,v)=>s+v,0)/x.pcts.length : calcPct(x.meta, x.av, null);
    return avg==null?0:Math.round(avg*10)/10;
  });
  const ctx = document.getElementById('chartIndicadores').getContext('2d');
  if (chartIndic) chartIndic.destroy();
  chartIndic = new Chart(ctx, {
    type:'bar',
    data:{ labels, datasets:[{ label:'% Cumplimiento', data: values }] },
    options:{ responsive:true, plugins:{ legend:{display:true}}, scales:{ y:{ beginAtZero:true, max:100 } } }
  });
}

/* ====== RENDER: ACTIVIDADES ====== */
function renderActividades(){
  const tb=document.getElementById('tblActividades'); tb.innerHTML='';
  const sorted=[...FILT].sort((a,b)=>{
    const d1=Number(a.anio_gestion)-Number(b.anio_gestion); if(d1!==0) return d1;
    const d2=mesToIdx(a.mes)-mesToIdx(b.mes); if(d2!==0) return d2;
    const d3=String(a.componente||"").localeCompare(String(b.componente||"")); if(d3!==0) return d3;
    return String(a.actividad_principal||"").localeCompare(String(b.actividad_principal||""));
  });
  sorted.forEach(r=>{
    const ev = r.evidencia_url ? `<a href="${r.evidencia_url}" target="_blank" class="text-blue-600 underline">Ver</a>` : '';
    tb.insertAdjacentHTML('beforeend', `
      <tr class="border-b last:border-0">
        <td class="py-2 pr-3">${r.anio_gestion??""}</td>
        <td class="py-2 pr-3">${r.componente??""}</td>
        <td class="py-2 pr-3">${r.actividad_principal??""}</td>
        <td class="py-2 pr-3">${r.subactividad??""}</td>
        <td class="py-2 pr-3">${r.tarea_especifica??""}</td>
        <td class="py-2 pr-3">${r.mes??""}</td>
        <td class="py-2 pr-3">${r.responsable??""}</td>
        <td class="py-2 pr-3">${badgeEstado(r.estado)}</td>
        <td class="py-2 pr-3">${ev}</td>
      </tr>
    `);
  });
}

/* ====== RENDER: CRONOGRAMA ====== */
function renderCronograma(){
  const tb=document.getElementById('tblCronograma'); tb.innerHTML='';
  const map=new Map();
  FILT.forEach(r=>{
    const key = `${r.actividad_principal}||${r.anio_gestion}||${r.componente}`;
    if(!map.has(key)) map.set(key, {act:r.actividad_principal, anio:r.anio_gestion, comp:r.componente, months:new Set()});
    const idx=mesToIdx(r.mes); if(idx>=0) map.get(key).months.add(idx);
  });
  const rows=[...map.values()].sort((a,b)=>{
    const c=String(a.comp||"").localeCompare(String(b.comp||"")); if(c!==0) return c;
    const y=Number(a.anio)-Number(b.anio); if(y!==0) return y;
    return String(a.act||"").localeCompare(String(b.act||""));
  });
  rows.forEach(x=>{
    const cells = Array.from({length:12},(_,i)=> x.months.has(i) ? '<div class="h-2 rounded bg-black"></div>' : '');
    tb.insertAdjacentHTML('beforeend', `
      <tr class="border-b last:border-0 align-middle">
        <td class="py-2 pr-3">${x.act??""}</td>
        <td class="py-2 pr-3">${x.anio??""}</td>
        <td class="py-2 pr-3">${x.comp??""}</td>
        ${cells.map(c=>`<td class="py-2 px-2">${c}</td>`).join('')}
      </tr>
    `);
  });
}

/* ====== RENDER: COMPONENTES ====== */
function renderComponentes(){
  const tb=document.getElementById('tblComponentes'); tb.innerHTML='';
  const compMap=new Map();
  FILT.forEach(r=>{
    const comp=r.componente||"—";
    const pct=calcPct(r.meta, r.avance, r.porcentaje_cumplimiento);
    if(!compMap.has(comp)) compMap.set(comp,{indSet:new Set(), pctVals:[], avances:0});
    const o=compMap.get(comp);
    if(r.indicador) o.indSet.add(`${r.anio_gestion}||${r.indicador}`);
    if(pct!=null) o.pctVals.push(pct);
    if(!isNaN(Number(r.avance))) o.avances += Number(r.avance);
  });
  const data=[...compMap.entries()].map(([k,v])=>{
    const prom = v.pctVals.length ? v.pctVals.reduce((s,x)=>s+x,0)/v.pctVals.length : null;
    return { comp:k, indicadores:v.indSet.size, promPct:prom, avances:v.avances };
  }).sort((a,b)=> String(a.comp).localeCompare(String(b.comp)));

  data.forEach(d=>{
    tb.insertAdjacentHTML('beforeend', `
      <tr class="border-b last:border-0">
        <td class="py-2 pr-3">${d.comp}</td>
        <td class="py-2 pr-3">${d.indicadores}</td>
        <td class="py-2 pr-3">${d.promPct==null?"":fmtPct(d.promPct)}</td>
        <td class="py-2 pr-3">${d.avances}</td>
      </tr>
    `);
  });

  const labels=data.map(d=>d.comp);
  const values=data.map(d=> d.promPct==null?0:Math.round(d.promPct*10)/10);
  const ctx=document.getElementById('chartComponentes').getContext('2d');
  if(chartComp) chartComp.destroy();
  chartComp = new Chart(ctx, {
    type:'bar',
    data:{ labels, datasets:[{ label:'Prom. % cumplimiento', data: values }]},
    options:{ responsive:true, plugins:{ legend:{display:true}}, scales:{ y:{ beginAtZero:true, max:100 } } }
  });
}

/* ====== EXPORT CSV ====== */
function exportCSV(){
  const cols=['anio_gestion','componente','indicador','meta','avance','porcentaje_cumplimiento','estado','actividad_principal','subactividad','tarea_especifica','responsable','mes','evidencia_url'];
  const esc=s=>{const v=(s==null)?"":String(s); return /[",\n]/.test(v)?`"${v.replace(/"/g,'""')}"`:v;};
  const lines=[cols.join(',')].concat(FILT.map(r=> cols.map(c=>esc(r[c])).join(',')));
  const blob=new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='proigualdad_export.csv'; a.click(); URL.revokeObjectURL(url);
}

/* ====== TABS ====== */
function initTabs(){
  const btns=document.querySelectorAll('.tabbtn');
  const sections={
    indicadores:document.getElementById('tab-indicadores'),
    actividades:document.getElementById('tab-actividades'),
    cronograma: document.getElementById('tab-cronograma'),
    componentes:document.getElementById('tab-componentes'),
  };
  btns.forEach(b=>{
    b.addEventListener('click', ()=>{
      btns.forEach(x=> x.classList.remove('bg-black','text-white'));
      b.classList.add('bg-black','text-white');
      const tab=b.dataset.tab;
      Object.entries(sections).forEach(([k,el])=>{
        if(k===tab) el.classList.remove('hidden'); else el.classList.add('hidden');
      });
    });
  });
}

/* ====== INICIO ====== */
async function main(){
  await testConnection();
  await fetchAll();
  populateFilterOptions();
  applyFilters();
  renderIndicadores();
  renderActividades();
  renderCronograma();
  renderComponentes();
}

document.getElementById('btnReload').addEventListener('click', main);
document.getElementById('btnExport').addEventListener('click', exportCSV);
document.getElementById('btnPrint').addEventListener('click', ()=>window.print());
document.getElementById('btnReset').addEventListener('click', ()=>{
  ['fAnio','fComponente','fEstado','fMes','fResp'].forEach(id=> document.getElementById(id).value="");
  applyFilters(); renderIndicadores(); renderActividades(); renderCronograma(); renderComponentes();
});
['fAnio','fComponente','fEstado','fMes','fResp'].forEach(id=>{
  document.getElementById(id).addEventListener('change', ()=>{
    applyFilters(); renderIndicadores(); renderActividades(); renderCronograma(); renderComponentes();
  });
});

initTabs();
main().catch(err=>{
  console.error(err);
  document.getElementById('connStatus').innerHTML = `<span class="badge bg-red-100 text-red-800">Error</span> ${err.message}`;
});
</script>
</body>
</html>

