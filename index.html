<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>ProIgualdad ‚Äì Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --giz-green:#7FFF00; --giz-red:#FF0000; --giz-yellow:#FFFF00;
      --giz-gray:#C0C0C0; --giz-blue:#4169E1;
      --ink:#111; --muted:#555; --border:#e5e7eb; --bg:#fff; --maxw:1200px;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial; color:var(--ink); background:var(--bg); line-height:1.4; }
    header{ border-bottom:1px solid var(--border); background:#fff; }
    .wrap{ max-width:var(--maxw); margin:auto; padding:16px 20px; }
    .hdr{ display:flex; align-items:center; gap:16px; justify-content:space-between; flex-wrap:wrap; }
    .brand h1{ margin:0; font-size:20px; font-weight:700; letter-spacing:.2px; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; }
    button, select{ padding:10px 12px; border:1px solid var(--border); background:#fff; border-radius:10px; cursor:pointer; font-weight:600; }
    button:hover{ background:#f8f9fb }
    .toolbar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .muted{ color:var(--muted); font-size:14px }
    .row{ display:grid; grid-template-columns:1fr; gap:16px; }
    @media(min-width:980px){ .row-2{ grid-template-columns:1fr 1fr; } }
    .card{ border:1px solid var(--border); border-radius:14px; padding:16px; background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .card h2{ margin:0 0 8px 0; font-size:18px; }

    .kpis{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px; }
    @media(min-width:760px){ .kpis{ grid-template-columns:repeat(5,minmax(0,1fr)); } }
    .kpi{ border:1px solid var(--border); border-radius:12px; padding:12px; background:#fafafa; text-align:center; }
    .kpi .dot{ display:inline-block; width:10px; height:10px; border-radius:50%; vertical-align:middle; margin-right:6px; }
    .kpi h3{ margin:6px 0 0 0; font-size:22px; }

    #chartBox{ width:100%; height:420px }

    /* Tabla compacta */
    table{ width:100%; border-collapse:collapse; font-size:13px; }
    th, td{ border-top:1px solid var(--border); padding:6px 8px; text-align:left; vertical-align:top; }
    th{ background:#fafafa; font-size:13px; }
    .badge{ display:inline-block; padding:3px 6px; border-radius:999px; font-size:12px; border:1px solid rgba(0,0,0,.08); background:#fff; }
    .b-green{ background:var(--giz-green); }
    .b-yellow{ background:var(--giz-yellow); }
    .b-red{ background:var(--giz-red); color:#fff; }
    .b-gray{ background:var(--giz-gray); }
    .b-blue{ background:var(--giz-blue); color:#fff; }

    /* Barras de Componentes */
    .prog{ margin-top:8px; height:8px; background:#eee; border-radius:999px; overflow:hidden; }
    .prog-fill{ height:8px; background:#4169E1; } /* color s√≥lido para imprimir mejor */

    .pagination{ display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; margin-top:8px; font-size:13px; }
    .pagination button{ padding:6px 10px; border-radius:6px; font-weight:500; }

    /* Imprimir / PDF */
    footer#print-footer{ display:none; }
    img.print-canvas{ display:none; max-width:100%; height:auto; }
    @media print{
      @page{ size:A4 landscape; margin:14mm; }
      header .actions{ display:none !important; }
      /* Fuerza colores de fondo en impresi√≥n */
      *{ -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .prog, .prog-fill, .badge{ -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      /* Mostrar imagen del canvas y ocultar el canvas original */
      canvas.hide-print{ display:none !important; }
      img.print-canvas{ display:block !important; }
      footer#print-footer{ display:block; position:fixed; bottom:6mm; left:0; right:0; text-align:center; font-size:11px; color:#333; }
      .card{ break-inside:avoid; }
      .pagination{ display:none; }
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap hdr">
      <div class="brand">
        <div>
          <h1>Sistema de Monitoreo ‚Äì ProIgualdad</h1>
          <div class="muted">Dashboard de indicadores por porcentaje de cumplimiento</div>
        </div>
      </div>
      <div class="actions">
        <button id="btnExportCSV">‚¨áÔ∏è CSV</button>
        <button id="btnExportXLSX">‚¨áÔ∏è XLSX</button>
        <button id="btnPrint">üñ®Ô∏è Imprimir / PDF</button>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <!-- Filtros -->
      <div class="card">
        <h2>Filtros</h2>
        <div class="toolbar">
          <label>A√±o: <select id="fAnio"><option value="">Todos</option></select></label>
          <label>Componente: <select id="fComponente"><option value="">Todos</option></select></label>
          <label>Estado: <select id="fEstado"><option value="">Todos</option></select></label>
          <label>Mes: <select id="fMes"><option value="">Todos</option></select></label>
          <label>Responsable: <select id="fResp"><option value="">Todos</option></select></label>
          <button id="btnClear">Limpiar filtros</button>
        </div>
      </div>

      <!-- KPIs -->
      <div class="card">
        <h2>KPIs por estado</h2>
        <div class="kpis">
          <div class="kpi"><span class="dot" style="background:var(--giz-green)"></span>Cumplida exitosamente<h3 id="kGreen">0</h3></div>
          <div class="kpi"><span class="dot" style="background:var(--giz-yellow)"></span>En proceso<h3 id="kYellow">0</h3></div>
          <div class="kpi"><span class="dot" style="background:var(--giz-red)"></span>Atrasada/Interrumpida/En riesgo<h3 id="kRed">0</h3></div>
          <div class="kpi"><span class="dot" style="background:var(--giz-gray)"></span>No puede iniciar/Concluir<h3 id="kGray">0</h3></div>
          <div class="kpi"><span class="dot" style="background:var(--giz-blue)"></span>Reprogramado<h3 id="kBlue">0</h3></div>
        </div>
      </div>

      <!-- Componentes (arriba) -->
      <div class="card">
        <h2>Componentes (avance promedio)</h2>
        <div id="componentesGrid" class="row row-2"></div>
      </div>

      <!-- Indicadores -->
      <div class="card">
        <h2>Indicadores (barras horizontales)</h2>
        <div class="muted">Etiquetas abreviadas (solo n√∫mero del indicador). El tooltip muestra el nombre completo.</div>
        <div id="chartBox"><canvas id="chartIndicadores"></canvas></div>
      </div>

      <!-- Actividades -->
      <div class="card">
        <h2>Actividades</h2>
        <div class="muted">Tabla con columnas clave, estado con color y paginaci√≥n.</div>
        <div class="table-wrap">
          <table id="tblActividades">
            <thead>
              <tr>
                <th>A√±o</th><th>Mes</th><th>Componente</th><th>Actividad principal</th>
                <th>Subactividad</th><th>Tarea espec√≠fica</th><th>Descripci√≥n</th>
                <th>Responsable</th><th>%</th><th>Estado</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <!-- Paginaci√≥n -->
        <div class="pagination">
          <div>
            <label>Filas por p√°gina:
              <select id="rowsPerPage">
                <option>10</option><option>25</option><option>50</option>
              </select>
            </label>
          </div>
          <div id="pageInfo"></div>
          <div>
            <button id="prevPage">‚¨ÖÔ∏è Anterior</button>
            <button id="nextPage">Siguiente ‚û°Ô∏è</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer id="print-footer">
    Reporte generado: <span id="genDate"></span> ¬∑ Proyecto ProIgualdad (GIZ)
  </footer>

  <script>
    /* ===== 1) SUPABASE ===== */
    const SUPABASE_URL="https://xrvxryozthadpzsgmbir.supabase.co";
    const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhydnhyeW96dGhhZHB6c2dtYmlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5ODA5NjcsImV4cCI6MjA3NDU1Njk2N30.mVDnVaJCiJzSEFJ2ZlHGrtbFk-DZNb61aDcrNf3KsHg";
    const supabaseClient=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

    /* ===== 2) UTIL ===== */
    const MES_IDX={enero:1,febrero:2,marzo:3,abril:4,mayo:5,junio:6,julio:7,agosto:8,septiembre:9,setiembre:9,octubre:10,noviembre:11,diciembre:12};
    const MES_NOMS=["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];

    function getEstadoClass(estado=""){
      const s=(estado||"").toLowerCase();
      if (s.includes("reprogram")) return "b-blue";
      if (s.includes("cumplida")) return "b-green";
      if (s.includes("proceso")) return "b-yellow";
      if (s.includes("no puede")) return "b-gray";
      if (s.match(/atras|interrump|riesg/)) return "b-red";
      return "";
    }

    // C√≥digo num√©rico del indicador; regla especial 2 -> 2.1
    function indicatorCode(ind){
      if(!ind) return "";
      const s=String(ind).trim();
      const m=s.match(/^(?:Indicador\s*)?(\d+(?:\.\d+)*)(?=[\s\.:/-]|$)/i);
      let code=m&&m[1] ? m[1] : s.replace(/[^\d.]/g,"").replace(/^\.+|\.+$/g,"");
      if (code==="2") code="2.1";
      return code || s.slice(0,6).toUpperCase();
    }
    // Orden natural 1 < 1.1 < 2 < 2.1 < 3.1.2 ...
    function compareCodes(a,b){
      const pa=String(a).split(".").map(n=>parseInt(n,10));
      const pb=String(b).split(".").map(n=>parseInt(n,10));
      const len=Math.max(pa.length,pb.length);
      for(let i=0;i<len;i++){ const va=pa[i]??0, vb=pb[i]??0; if(va!==vb) return va-vb; }
      return 0;
    }
    function formatFechaBO(d=new Date()){
      try{
        return new Intl.DateTimeFormat("es-BO",{timeZone:"America/La_Paz",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(d);
      }catch{ return d.toLocaleString(); }
    }
    function setChartHeightByCount(count){
      const px=Math.max(260, Math.min(1600, (count*26)+120));
      document.getElementById("chartBox").style.height=px+"px";
    }
    // CSV/XLSX helpers
    function toCSV(rows){
      if(!rows.length) return "";
      const cols=Object.keys(rows[0]); const esc=v=>`"${String(v??"").replace(/"/g,'""')}"`;
      return cols.map(esc).join(",")+"\n"+rows.map(r=>cols.map(c=>esc(r[c])).join(",")).join("\n");
    }
    function downloadXLSX(rows, filename){
      const ws=XLSX.utils.json_to_sheet(rows); const wb=XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "datos"); XLSX.writeFile(wb, filename);
    }

    /* ===== 3) ESTADO ===== */
    let RAW=[], FILTERED=[], CHART;
    let currentPage=1, rowsPerPage=10;

    // Filtros DOM
    const fAnio=document.getElementById("fAnio");
    const fComponente=document.getElementById("fComponente");
    const fEstado=document.getElementById("fEstado");
    const fMes=document.getElementById("fMes");
    const fResp=document.getElementById("fResp");

    const rowsSelect=document.getElementById("rowsPerPage");
    const pageInfo=document.getElementById("pageInfo");

    /* ===== 4) CARGA ===== */
    async function loadData(){
      const { data, error } = await supabaseClient
        .from("entradas_form")
        .select("anio_gestion, mes, componente, objetivo, indicador, actividad_principal, subactividad, tarea_especifica, descripcion, responsable, meta, porcentaje_cumplimiento, estado");
      if(error){ console.error(error); alert("Error al cargar datos desde Supabase."); return; }
      RAW=(data||[]).map(r=>{
        const ms=String(r.mes||"").toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,"");
        const idx=MES_IDX[ms]||null;
        return {...r, _mes_idx:idx, _mes_abbr: idx ? MES_NOMS[idx-1] : ""};
      });
    }

    /* ===== 5) FILTROS ===== */
    function fillFilterOptions(){
      const uniq=a=>[...new Set(a.filter(v=>v!=null && v!==""))];
      const set=(sel,vals)=>{ sel.innerHTML=`<option value="">Todos</option>`+vals.map(v=>`<option>${v}</option>`).join(""); };
      set(fAnio, uniq(RAW.map(r=>r.anio_gestion)).sort());
      set(fComponente, uniq(RAW.map(r=>r.componente)).sort());
      set(fEstado, uniq(RAW.map(r=>r.estado)).sort());
      set(fMes, uniq(RAW.map(r=>r._mes_abbr)).sort((a,b)=>MES_NOMS.indexOf(a)-MES_NOMS.indexOf(b)));
      set(fResp, uniq(RAW.map(r=>r.responsable)).sort());
    }
    function applyFilters(){
      FILTERED=RAW.filter(r=>{
        if (fAnio.value && r.anio_gestion!=fAnio.value) return false;
        if (fComponente.value && r.componente!=fComponente.value) return false;
        if (fEstado.value && r.estado!=fEstado.value) return false;
        if (fMes.value && r._mes_abbr!=fMes.value) return false;
        if (fResp.value && r.responsable!=fResp.value) return false;
        return true;
      });
      currentPage=1; // reset paginaci√≥n al filtrar
    }

    /* ===== 6) KPIs ===== */
    function renderKPIs(){
      const c={green:0,yellow:0,red:0,gray:0,blue:0};
      for(const r of FILTERED){
        const cls=getEstadoClass(r.estado);
        if(cls==="b-green") c.green++;
        else if(cls==="b-yellow") c.yellow++;
        else if(cls==="b-gray") c.gray++;
        else if(cls==="b-blue") c.blue++;
        else c.red++;
      }
      kGreen.textContent=c.green; kYellow.textContent=c.yellow; kRed.textContent=c.red; kGray.textContent=c.gray; kBlue.textContent=c.blue;
    }

    /* ===== 7) COMPONENTES ===== */
    function renderComponentes(){
      const tgt=document.getElementById("componentesGrid"); tgt.innerHTML="";
      const agg=new Map();
      for(const r of FILTERED){
        const k=r.componente||"(Sin componente)";
        const v=Number(r.porcentaje_cumplimiento)||0;
        if(!agg.has(k)) agg.set(k,{s:0,n:0});
        const o=agg.get(k); o.s+=v; o.n++;
      }
      const rows=[...agg.entries()].map(([k,{s,n}])=>({k, prom:n? s/n : 0, n})).sort((a,b)=>a.k.localeCompare(b.k));
      for(const r of rows){
        const card=document.createElement("div");
        card.className="card";
        card.innerHTML=`
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
            <div><div class="muted">Componente</div><div style="font-weight:700">${r.k}</div></div>
            <div style="text-align:right"><div class="muted">Promedio</div><div style="font-size:22px;font-weight:800">${r.prom.toFixed(1)}%</div><div class="muted">${r.n} registros</div></div>
          </div>
          <div class="prog"><div class="prog-fill" style="width:${Math.min(100,Math.max(0,r.prom)).toFixed(1)}%"></div></div>`;
        tgt.appendChild(card);
      }
    }

    /* ===== 8) GR√ÅFICO ===== */
    function renderChart(){
      // Agrupa por indicador COMPLETO ‚Üí promedio
      const byFull=new Map();
      for(const r of FILTERED){
        const full=r.indicador||"";
        const v=Number(r.porcentaje_cumplimiento)||0;
        if(!byFull.has(full)) byFull.set(full,{s:0,n:0});
        const o=byFull.get(full); o.s+=v; o.n++;
      }
      // Mapea a code y consolida por code (si hay duplicados deja el mayor promedio)
      const byCode=new Map();
      for(const [full,{s,n}] of byFull.entries()){
        const code=indicatorCode(full);
        const prom=n ? s/n : 0;
        const prev=byCode.get(code);
        if(!prev || prom>prev.prom) byCode.set(code,{code,full,prom});
      }
      const rows=[...byCode.values()].sort((a,b)=>compareCodes(a.code,b.code));

      const labelsShort=rows.map(r=>r.code);
      const labelsFull=rows.map(r=>r.full);
      const values=rows.map(r=>Number(r.prom.toFixed(1)));

      setChartHeightByCount(labelsShort.length);
      if(CHART) CHART.destroy();
      const ctx=document.getElementById("chartIndicadores").getContext("2d");
      CHART=new Chart(ctx,{
        type:"bar",
        data:{ labels:labelsShort, datasets:[{
          label:"% promedio de cumplimiento",
          data:values,
          backgroundColor:"rgba(65,105,225,0.8)",
          borderColor:"rgba(65,105,225,1)",
          borderWidth:1.2, borderSkipped:false, barThickness:"flex"
        }]},
        options:{
          responsive:true, maintainAspectRatio:false, indexAxis:"y",
          scales:{
            x:{ min:0, max:100, grid:{color:"rgba(0,0,0,0.06)"},
                ticks:{ callback:v=>v+" %", font:{size:12} },
                title:{ display:true, text:"Porcentaje de cumplimiento (%)" } },
            y:{ grid:{display:false}, ticks:{autoSkip:false, font:{size:12}} }
          },
          plugins:{
            legend:{display:false},
            tooltip:{ callbacks:{
              title:(items)=> labelsFull[items?.[0]?.dataIndex ?? 0],
              label:(it)=> ` ${it.raw}%`
            }}
          }
        }
      });
    }

    /* ===== 9) ACTIVIDADES + PAGINACI√ìN ===== */
    function renderActividades(){
      const tb=document.querySelector("#tblActividades tbody");
      tb.innerHTML="";
      const total=FILTERED.length;
      const start=(currentPage-1)*rowsPerPage;
      const end=Math.min(start+rowsPerPage, total);
      const pageData=FILTERED.slice(start,end);

      for(const r of pageData){
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td>${r.anio_gestion ?? ""}</td>
          <td>${r._mes_abbr ?? ""}</td>
          <td>${r.componente ?? ""}</td>
          <td>${r.actividad_principal ?? ""}</td>
          <td>${r.subactividad ?? ""}</td>
          <td>${r.tarea_especifica ?? ""}</td>
          <td>${r.descripcion ?? ""}</td>
          <td>${r.responsable ?? ""}</td>
          <td>${r.porcentaje_cumplimiento ?? ""}</td>
          <td><span class="badge ${getEstadoClass(r.estado)}">${r.estado || ""}</span></td>`;
        tb.appendChild(tr);
      }

      pageInfo.textContent = total ? `Mostrando ${start+1}‚Äì${end} de ${total} actividades` : "Sin registros";
      document.getElementById("prevPage").disabled = currentPage===1;
      document.getElementById("nextPage").disabled = end>=total;
    }
    function goPage(delta){
      currentPage = Math.max(1, currentPage + delta);
      renderActividades();
    }

    /* ===== 10) EXPORTAR ===== */
    function getFilteredForExport(){
      return FILTERED.map(r=>({
        anio_gestion:r.anio_gestion, mes:r._mes_abbr || r.mes, componente:r.componente,
        objetivo:r.objetivo, indicador:r.indicador, actividad_principal:r.actividad_principal,
        subactividad:r.subactividad, tarea_especifica:r.tarea_especifica, descripcion:r.descripcion,
        responsable:r.responsable, meta:r.meta, porcentaje_cumplimiento:r.porcentaje_cumplimiento,
        estado:r.estado
      }));
    }
    function exportCSV(){
      const csv=toCSV(getFilteredForExport());
      const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
      const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="proigualdad_export.csv"; a.click(); URL.revokeObjectURL(a.href);
    }
    function exportXLSX(){ downloadXLSX(getFilteredForExport(), "proigualdad_export.xlsx"); }

    /* ===== 11) RENDER GENERAL ===== */
    function renderAll(){
      applyFilters();
      renderKPIs();
      renderComponentes();
      renderChart();
      renderActividades();
    }

    /* ===== 12) PREPARAR IMPRESI√ìN ===== */
    let printPrepared = false;
    let printPairs = []; // [{cv, img}]
    function preparePrint(){
      if (printPrepared) return;
      printPrepared = true;
      // Reemplaza cada canvas por una imagen para impresi√≥n
      document.querySelectorAll("canvas").forEach(cv=>{
        try{
          const img = document.createElement("img");
          img.src = cv.toDataURL("image/png");
          img.className = "print-canvas";
          img.alt = cv.getAttribute("aria-label") || "gr√°fico";
          cv.classList.add("hide-print");
          cv.insertAdjacentElement("afterend", img);
          printPairs.push({cv, img});
        }catch(e){ /* ignorar */ }
      });
      // Fecha en pie
      document.getElementById("genDate").textContent = formatFechaBO(new Date());
    }
    function cleanupPrint(){
      printPairs.forEach(({cv,img})=>{ img.remove(); cv.classList.remove("hide-print"); });
      printPairs = [];
      printPrepared = false;
    }

    /* ===== 13) INIT + EVENTOS ===== */
    async function init(){ await loadData(); fillFilterOptions(); renderAll(); }
    init();

    // Filtros
    [fAnio,fComponente,fEstado,fMes,fResp].forEach(sel => sel.addEventListener("change", renderAll));
    document.getElementById("btnClear").addEventListener("click", ()=>{ [fAnio,fComponente,fEstado,fMes,fResp].forEach(s=>s.value=""); renderAll(); });

    // Exportar
    document.getElementById("btnExportCSV").addEventListener("click", exportCSV);
    document.getElementById("btnExportXLSX").addEventListener("click", exportXLSX);

    // Paginaci√≥n
    rowsSelect.addEventListener("change", ()=>{ rowsPerPage=+rowsSelect.value; currentPage=1; renderActividades(); });
    document.getElementById("prevPage").addEventListener("click", ()=> goPage(-1));
    document.getElementById("nextPage").addEventListener("click", ()=> goPage(1));

    // Imprimir / PDF
    document.getElementById("btnPrint").addEventListener("click", ()=>{ preparePrint(); window.print(); });
    window.addEventListener("beforeprint", preparePrint);
    window.addEventListener("afterprint", cleanupPrint);
  </script>
</body>
</html>
